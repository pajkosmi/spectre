<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="author" content="SXS Collaboration">
    <meta name="generator" content="Doxygen 1.9.3"/>
  <title>SpECTRE: GitHub Actions Continuous Integration</title>
  <link href="tabs.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="./MathJax.js"></script>
  <link href="octicons.css" rel="stylesheet">
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script type="text/javascript" src="spectre.js"></script>
  <script type="text/javascript" src="doxygen-navtree-hacks.js"></script>
  <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeParagraphLink.init()
  </script>
  </head>
  <body>
  <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
  <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
      <tbody>
        <tr style="height: 56px;">
          <td id="projectalign" style="padding-left: 0.5em;">
            <div id="projectname">
              <a href="index.html">SpECTRE</a>
              &#160;<span id="projectnumber">v2023.06.19</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('github_actions_guide.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">GitHub Actions Continuous Integration </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#github_actions_ci">Testing SpECTRE with GitHub Actions CI</a><ul><li class="level2"><a href="#what-is-tested">What is tested</a></li>
<li class="level2"><a href="#perform-checks-locally">How to perform the checks locally</a></li>
<li class="level2"><a href="#github-actions-troubleshooting">Troubleshooting</a></li>
<li class="level2"><a href="#precompiled-headers-ccache">Precompiled Headers and ccache</a></li>
<li class="level2"><a href="#caching-mac-os">Caching Dependencies on macOS Builds</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_DevGuide_GitHubActions"></a></p>
<h1><a class="anchor" id="github_actions_ci"></a>
Testing SpECTRE with GitHub Actions CI</h1>
<p >SpECTRE uses <a href="https://github.com/features/actions">GitHub Actions</a> for testing the code. Multiple build jobs (described below) are launched each time a pull request is submitted or updated. GitHub Actions will also launch these build jobs each time you push to a branch on your fork of SpECTRE if you enable it. GitHub Actions is also used to deploy releases of the code.</p>
<p >For pull requests, you can view the GitHub Actions CI build by clicking on the <code>Checks</code> tab. Near the bottom of the <code>Conversation</code> tab a summary of the CI results are presented. You can view all of the GitHub Actions runs by clicking on the <code>Actions</code> section.</p>
<h2><a class="anchor" id="what-is-tested"></a>
What is tested</h2>
<p >The GitHub Actions report lists the build jobs which will each have either a green check mark if it passes, a red <code>X</code> if it has failed, or a yellow dot with a circle if the build is in progress. Clicking on a build job will display the log of the build.</p>
<p >The following build jobs are launched:</p><ul>
<li>CHECK_COMMITS runs the script <code>tools/CheckCommits.sh</code> and fails the build if any casing of the words in the list below is the first word of the commit message. This allows developers to flag their commits with these keywords to indicate that a pull request should not be merged in its current state.<ul>
<li>fixup</li>
<li>wip (for work in progress)</li>
<li>fixme</li>
<li>deleteme</li>
<li>rebaseme</li>
<li>testing</li>
<li>rebase</li>
</ul>
</li>
<li>CHECK_FILES runs the script <code>tools/CheckFiles.sh</code> (which also runs the script <code>tools/FileTestDefs.sh</code>). The checks fail if any of the following are true:<ul>
<li>Any file,<ul>
<li>contains a line over 80 characters (We allow exceptions for certain file types and inherently long strings like URLs and include lines. See <code>tools/FileTestDefs.sh</code> for the full list of exceptions.)</li>
<li>is missing the license line</li>
<li>does not end with a newline</li>
<li>contains a tab character</li>
<li>contains white space at the end of a line</li>
<li>contains a carriage return character</li>
</ul>
</li>
<li>A <code>c++</code> header file (i.e., <code>*.hpp</code> or <code>*.tpp</code>) is missing <code>#pragma once</code></li>
<li>A <code>c++</code> file (i.e., <code>*.hpp</code>, <code>*.tpp</code>, or <code>*.cpp</code>) file,<ul>
<li>includes <code>&lt;iostream&gt;</code> (useless when running in parallel)</li>
<li>includes <code>&lt;lrtslock.h&gt;</code> (use <code>&lt;converse.h&gt;</code> instead)</li>
<li>includes <code>"Utilities/TmplDebugging.hpp"</code> (used only for debugging)</li>
<li>includes any non-header <code>*.cpp</code> file</li>
<li>contains a <code>namespace</code> ending in <code>_details</code> (use <code>_detail</code>)</li>
<li>contains a <code>struct TD</code> or <code>class TD</code> (used only for debugging)</li>
<li>contains <code><a class="elRef" href="http://en.cppreference.com/w/cpp/types/enable_if.html">std::enable_if</a></code> (use <code>Requires</code> instead)</li>
<li>contains <code>Ls</code> (use <code>List</code> instead)</li>
<li>contains additional text after <code>/*!</code> (does not render correctly in Doxygen)</li>
<li>contains the string <code>return Py_None;</code> (bug prone, use <code>Py_RETURN_NONE</code> instead)</li>
<li>contains <code>.ckLocal()</code> or <code>.ckLocalBranch()</code> (use <code><a class="el" href="namespaceParallel.html#a7c3299e04cea9f206f194e7b118c7b44" title="Wrapper for calling Charm++&#39;s .ckLocal() on a proxy.">Parallel::local</a></code> or <code><a class="el" href="namespaceParallel.html#a3e4ca5b6143a3b8a8c5c1dd9dacf3d08" title="Wrapper for calling Charm++&#39;s .ckLocalBranch() on a proxy.">Parallel::local_branch</a></code> instead)</li>
</ul>
</li>
<li>A <code>c++</code> test,<ul>
<li>uses <code>TEST_CASE</code> (use <code>SPECTRE_TEST_CASE</code> instead)</li>
<li>uses <code>Approx</code> (use <code>approx</code> instead)</li>
</ul>
</li>
<li>A <code>CMakeLists.txt</code> file in <code>src</code>, but not in an Executables or Python-binding directory,<ul>
<li>does not list a <code>C++</code> file that is present in the directory</li>
<li>lists a <code>C++</code> file that is not present in the directory</li>
</ul>
</li>
<li>A <code>c++</code> or <code>python</code> file contains a <code>TODO</code> (case-insensitive) comment</li>
<li>The file <code>tests/Unit/RunSingleTest/CMakeLists.txt</code> wasn't modified In addition, the CHECK_FILES job tests Python formatting, the release workflow, and other tools in <code>tools/</code>.</li>
</ul>
</li>
<li>RUN_CLANG_TIDY runs clang-tidy on the source code. This is done for both <code>Release</code> and <code>Debug</code> builds.</li>
<li>TEST_CHECK_FILES runs <code>tools/CheckFiles.sh --test</code> which tests the checks performed in the CHECK_FILES build.</li>
<li>The other builds compile the code and run the tests for both <code>Release</code> and <code>Debug</code> builds, for the <code>gcc</code> and <code>clang</code> compilers using a Linux OS, and the <code>AppleClang</code> compiler for <code>OS X</code>.</li>
<li>Verify the documentation builds successfully. Builds of <code>develop</code> deploy the documentation to GitHub pages.</li>
</ul>
<h2><a class="anchor" id="perform-checks-locally"></a>
How to perform the checks locally</h2>
<p >Before pushing to GitHub and waiting for GitHub Actions to perform the checks it is useful to perform at least the following tests locally:</p><ul>
<li><p class="startli"><b>Unit tests:</b> Perform a <code>make unit-tests</code> and then execute <code>ctest -L Unit</code> to run all unit tests. As for <code>make</code> you can append a <code>-jN</code> flag to <code>ctest</code> to run in parallel on <code>N</code> cores. To run only a subset of the tests you can use one of the other keywords that the tests are labeled with, such as <code>ctest -L datastructures</code>. To run only particular tests you can also execute <code>ctest -R TEST_NAME</code> instead, where <code>TEST_NAME</code> is a regular expression matching the test identifiers such as <code>Unit.DataStructures.Mesh</code>. Pass the flag <code>--output-on-failure</code> to get output from failed tests. Consult <code>ctest -h</code> for further options.</p>
<p class="startli">To run the input file tests you must build the executables using <code>make test-executables</code>. You can then run <code>ctest -LE unit</code> to run everything except for the unit tests, or <code>ctest</code> to run all tests.</p>
</li>
<li><b>clang-tidy:</b> In a clang build directory, run <code>make clang-tidy FILE=SOURCE_FILE</code> where <code>SOURCE_FILE</code> is a relative or absolute path to a <code>.cpp</code> file. To perform this check for all source files that changed in your pull request, <code>make clang-tidy-hash HASH=UPSTREAM_HEAD</code> where <code>UPSTREAM_HEAD</code> is the hash of the commit that your pull request is based on, usually the <code>HEAD</code> of the <code>upstream/develop</code> branch.</li>
<li><b>Documentation:</b> To render the documentation for the current state of the source tree the command <code>make doc</code> (or <code>make doc-check</code> to highlight warnings) can be used, placing its result in the <code>docs</code> directory in the build tree. Once code has been made into a pull request to GitHub, the documentation can be rendered locally using the <code>tools/pr-docs</code> script. To view the documentation, simply open the <code>index.html</code> file in the <code>html</code> subdirectory in a browser. Some functionality requires a web server (e.g. citation popovers), so just run a <code>python3 -m http.server</code> in the <code>html</code> directory to enable this.</li>
<li><b>IWYU:</b> We experimented for a time using IWYU (include what you use) as an automated check for correct includes and forward declarations. Unfortunately it gave many incorrect suggestions. We have decided to no longer have a IWYU check with GitHub Actions, but have left support for IWYU so that it can be used locally. To do so just for the changed files in a pull request run <code>make iwyu-hash HASH=UPSTREAM_HEAD</code>. Since IWYU requires <code>USE_PCH=OFF</code> you can create a separate build directory and append <code>-D USE_PCH=OFF</code> to the usual <code>cmake</code> call. Note that it is very easy to incorrectly install IWYU (if not using the Docker container) and generate nonsense errors. Note that we have left IWYU pragmas in the code, but no longer require they be added so that IWYU gives no errors when run. As IWYU is still under development, we plan to investigate using it again in the future.</li>
<li>The <code>gcc Debug</code> build runs code coverage for each GitHub Actions build.</li>
</ul>
<h2><a class="anchor" id="github-actions-troubleshooting"></a>
Troubleshooting</h2>
<ul>
<li>Occasionally, a build job will fail because of a problem with GitHub Actions (e.g. it times out). On the <code>Checks</code> tab you can restart all or only the failed jobs. In the top right corner there's a <code>Re-run jobs</code> menu, which also has <code>Re-run failed jobs</code>. This button is <code>Cancel workflow</code> during the build process. Note that these buttons are only available if you have write access to the repository (core developer status).</li>
<li><p class="startli">GitHub Actions caches some things between builds. Occasionally this may cause a problem leading to strange build failures. For example, inexplicable segfaults on seemingly random tests or <code>Illegal instruction</code> failures. We have to be fairly lax with our caching policies, and so the cache can become stale and outdated when a new container is pushed, among other difficult to understand situations. You can rebuild the ccache by going to <code>Actions</code>, then select the <code>Tests</code> workflow on the left, click the <code>Run workflow</code> drop-down menu, and enter <code>yes</code> in the input field below the ccache discussion.</p>
<p class="startli">If clearing the ccache doesn't help, it could be that a Docker image layer is not being updated. GitHub doesn't (yet) have a way to clear the cache, so instead we clobber it to force GitHub to eject all old caches, both ccache and Docker images, along with anything else. To do this go to <code>Actions</code>, select the <code>Clobber Cache</code> workflow, then run it on develop. This will dump 9.9GB of random data into the cache. The amount is specified in the <code>ClobberCache.yaml</code> workflow file and needs to be updated if GitHub increases their cache size. The current cache size limit is 10GB per repository.</p>
<p class="startli">Note that starting these workflows is only possible if you have write access to the repository (core developer status).</p>
</li>
</ul>
<h2><a class="anchor" id="precompiled-headers-ccache"></a>
Precompiled Headers and ccache</h2>
<p >Getting ccache to work with precompiled headers on GitHub Actions is a little challenging. The header to be precompiled is <code>${SPECTRE_SOURCE_DIR}/tools/SpectrePch.hpp</code> and is symbolically linked to <code>${SPECTRE_BUILD_DIR}/SpectrePch.hpp</code>. The configuration that seems to work is specifying the environment variables:</p>
<div class="fragment"><div class="line">CCACHE_COMPILERCHECK=content</div>
<div class="line">CCACHE_EXTRAFILES=&quot;${SPECTRE_SOURCE_DIR}/tools/SpectrePch.hpp&quot;</div>
<div class="line">CCACHE_IGNOREHEADERS=\</div>
<div class="line">  &quot;${SPECTRE_BUILD_DIR}/SpectrePch.hpp:${SPECTRE_BUILD_DIR}/SpectrePch.hpp.gch&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="caching-mac-os"></a>
Caching Dependencies on macOS Builds</h2>
<p >On macOS builds we cache all of our dependencies, like LIBXSMM and Charm++. These are cached in <code>$HOME/mac_cache</code>. Ultimately this saves about 10-12 minutes even when compared to using ccache to cache the object files from building the dependencies. We also cache <code>$HOME/Library/Caches/Homebrew</code>, which is where Homebrew keeps the downloaded formulas. By caching the Homebrew bottles we are able to avoid brew formulas building from source because a tarball of the package was not available at the time. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dev_guide.html">Developer Guides</a></li>
    <li class="footer">
    &copy; Copyright 2017 - 2023
    <a href="https://black-holes.org">SXS Collaboration</a>,
    <a href="LICENSE.txt" target="_blank">
    <span class="hidden-xs">Distributed under the</span>
    MIT License</a>
  </ul>
</div>
</body>
</html>
