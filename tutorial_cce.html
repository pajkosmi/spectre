<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="author" content="SXS Collaboration">
    <meta name="generator" content="Doxygen 1.9.3"/>
  <title>SpECTRE: Running CCE</title>
  <link href="tabs.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="./MathJax.js"></script>
  <link href="octicons.css" rel="stylesheet">
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script type="text/javascript" src="spectre.js"></script>
  <script type="text/javascript" src="doxygen-navtree-hacks.js"></script>
  <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeParagraphLink.init()
  </script>
  </head>
  <body>
  <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
  <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
      <tbody>
        <tr style="height: 56px;">
          <td id="projectalign" style="padding-left: 0.5em;">
            <div id="projectname">
              <a href="index.html">SpECTRE</a>
              &#160;<span id="projectnumber">v2023.06.19</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('tutorial_cce.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Running CCE </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md43">Input data formats</a></li>
</ul>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_Tutorials_CCE"></a></p>
<p >The basic instructions for getting up and running with a stand-alone CCE using external data are:</p><ul>
<li>Clone spectre and build the CharacteristicExtract target</li>
<li>At this point (provided the build succeeds) you should have the executable <code>bin/CharacteristicExtract</code> in the build directory; You can now run it using an input file to provide options. The input file <code>tests/InputFiles/Cce/CharacteristicExtract.yaml</code> from the spectre source tree can help you get started with writing your input file. There are a few important notes there:<ul>
<li>For resolution, the example input file has lmax (<code>Cce.LMax</code>) of 20, and filter lmax (<code>Filtering.FilterLMax</code>) of 18; that may run a bit slow for basic tests, but this value yields the best precision-to-run-time ratio for a typical BBH system. Note that precision doesn't improve above lmax 24, filter 22 (be sure to update the filter as you update lmax &ndash; it should generally be around 2 lower than the maximum l to reduce possible aliasing).</li>
<li>If you want to just run through the end of the provided worldtube data, you can just omit the <code>EndTime</code> option and the executable will figure it out from the worldtube file.</li>
<li>The <code>ScriOutputDensity</code> adds extra interpolation points to the output, which is useful for finite-difference derivatives on the output data, but otherwise it'll just unnecessarily inflate the output files, so if you don't need the extra points, best just set it to 1.</li>
<li>If you're extracting at 100M or less (which isn't currently recommended due to the junk radiation being much worse), best to keep the <code>TargetStepSize</code> as .5 for 100M and perhaps even lower yet for nearer extraction.</li>
<li>The <code>InitializeJ</code> in the example file uses <code>ConformalFactor</code> which has been found to perform better than the other schemes implemented so far. Other schemes for <code>InitializeJ</code> can be found in namespace <a class="el" href="namespaceCce_1_1InitializeJ.html">Cce::InitializeJ</a>. Some of these are:<ul>
<li><code>ZeroNonSmooth</code>: Make <code>J</code> vanish</li>
<li><code>NoIncomingRadiation</code>: Make \(\Psi_0 = 0\); this does not actually lead to no incoming radiation, since \(\Psi_0\) and \(\Psi_4\) both include incoming and outgoing radiation.</li>
<li><code>InverseCubic</code>: Ansatz where \(J = A/r + B/r^3\)</li>
<li><code>ConformalFactor</code>: Try to make initial time coordinate as inertial as possible at \(\mathscr{I}^+\).</li>
</ul>
</li>
</ul>
</li>
<li>An example of an appropriate submission command for slurm systems is: <div class="fragment"><div class="line">srun -n 1 -c 1 path/to/build/bin/CharacteristicExtract ++ppn 3 \</div>
<div class="line">--input-file path/to/input.yaml</div>
</div><!-- fragment --> CCE doesn't currently scale to more than 4 cores, so those slurm options are best.</li>
<li>CCE will work faster if the input worldtube hdf5 file is chunked in small numbers of complete rows. This is relevant because by default, SpEC writes its worldtube files chunked along full time-series columns, which is efficient for compression, but not for reading in to SpECTRE &ndash; in that case, it is recommended to rechunk the input file before running CCE for maximum performance. This can be done, for instance, using h5py (you will need to fill in filenames appropriate to your case in place of "BondiCceR0050.h5" and "RechunkBondiCceR0050.h5"): <div class="fragment"><div class="line"><span class="keyword">import</span> h5py</div>
<div class="line">input_file = <span class="stringliteral">&quot;BondiCceR0050.h5&quot;</span></div>
<div class="line">output_file = <span class="stringliteral">&quot;RechunkBondiCceR0050.h5&quot;</span></div>
<div class="line"><span class="keyword">with</span> h5py.File(input_file,<span class="stringliteral">&#39;r&#39;</span>) <span class="keyword">as</span> input_h5,\</div>
<div class="line">  h5py.File(output_file, <span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> output_h5:</div>
<div class="line">  <span class="keywordflow">for</span> dset <span class="keywordflow">in</span> input_h5:</div>
<div class="line">      if(<span class="stringliteral">&quot;Version&quot;</span> <span class="keywordflow">in</span> dset):</div>
<div class="line">          output_h5[dset] = input_h5[dset][()]</div>
<div class="line">          <span class="keywordflow">continue</span></div>
<div class="line">      number_of_columns = input_h5[dset][()].shape[1]</div>
<div class="line">      output_h5.create_dataset(dset, data=input_h5[dset],</div>
<div class="line">                               maxshape=(<span class="keywordtype">None</span>, number_of_columns),</div>
<div class="line">                               chunks=(4, number_of_columns), dtype=<span class="stringliteral">&#39;d&#39;</span>)</div>
<div class="line">      <span class="keywordflow">for</span> attribute <span class="keywordflow">in</span> input_h5[dset].attrs.keys():</div>
<div class="line">          output_h5[dset].attrs[attribute] = input_h5[dset].attrs[attribute]</div>
</div><!-- fragment --></li>
<li>Note, these <code>*.<a class="el" href="namespaceh5.html" title="Contains functions and classes for manipulating HDF5 files.">h5</a></code> files required as an <code>input_file</code> (and also needed in the <code>.yaml</code> file) will need to be obtained from an SXS member who has completed a relevant <code>SpEC</code> run.</li>
<li>The output data will be written as spin-weighted spherical harmonic modes, one physical quantity per dataset, and each row will have the time value followed by the real and imaginary parts of the complex modes in m-varies-fastest order.</li>
</ul>
<p >Once you have the reduction data output file from a successful CCE run, you can confirm the integrity of the <a class="el" href="namespaceh5.html" title="Contains functions and classes for manipulating HDF5 files.">h5</a> file and its contents by running </p><div class="fragment"><div class="line">h5ls CharacteristicExtractReductionData.h5/Cce.dir</div>
</div><!-- fragment --><p >For the reduction file produced by a successful run, the output of the <code>h5ls</code> should resemble </p><div class="fragment"><div class="line">EthInertialRetardedTime.dat Dataset {3995/Inf, 163}</div>
<div class="line">News.dat                 Dataset {3995/Inf, 163}</div>
<div class="line">Psi0.dat                 Dataset {3995/Inf, 163}</div>
<div class="line">Psi1.dat                 Dataset {3995/Inf, 163}</div>
<div class="line">Psi2.dat                 Dataset {3995/Inf, 163}</div>
<div class="line">Psi3.dat                 Dataset {3995/Inf, 163}</div>
<div class="line">Psi4.dat                 Dataset {3995/Inf, 163}</div>
<div class="line">Strain.dat               Dataset {3995/Inf, 163}</div>
<div class="line">src.tar.gz               Dataset {3750199}</div>
</div><!-- fragment --><p >The <code>Strain.dat</code> represents the asymptotic transverse-traceless contribution to the metric scaled by the Bondi radius (to give the asymptotically leading part), the <code>News.dat</code> represents the first derivative of the strain, and each of the <code>Psi...</code> datasets represent the Weyl scalars, each scaled by the appropriate factor of the Bondi-Sachs radius to retrieve the asymptotically leading contribution.</p>
<p >The <code>EthInertialRetardedTime.dat</code> is a diagnostic dataset that represents the angular derivative of the inertial retarded time, which determines the coordinate transformation that is performed at scri+.</p>
<p >The following python script will load data from a successful CCE run and construct a plot of all of the physical waveform data. </p><div class="fragment"><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div>
<div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="keyword">import</span> h5py <span class="keyword">as</span> h5</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>spectre_real_mode_index(l, m):</div>
<div class="line">    <span class="keywordflow">return</span> 2 * (l**2 + l + m) + 1</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>spectre_imag_mode_index(l, m):</div>
<div class="line">    <span class="keywordflow">return</span> 2 * (l**2 + l + m) + 2</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>get_modes_from_block_output(filename, dataset, modes=[[2, 2], [3, 3]]):</div>
<div class="line">    <span class="keyword">with</span> h5.File(filename, <span class="stringliteral">&quot;r&quot;</span>) <span class="keyword">as</span> h5_file:</div>
<div class="line">        timeseries_data = (h5_file[dataset + <span class="stringliteral">&quot;.dat&quot;</span>][()][:, [0] + list(</div>
<div class="line">            np.array([[</div>
<div class="line">                spectre_real_mode_index(x[0], x[1]),</div>
<div class="line">                spectre_imag_mode_index(x[0], x[1])</div>
<div class="line">            ] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> modes]).flatten())])</div>
<div class="line">    <span class="keywordflow">return</span> timeseries_data</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">plot_quantities = [<span class="stringliteral">&quot;Strain&quot;</span>, <span class="stringliteral">&quot;News&quot;</span>, <span class="stringliteral">&quot;Psi0&quot;</span>, <span class="stringliteral">&quot;Psi1&quot;</span>, <span class="stringliteral">&quot;Psi2&quot;</span>, <span class="stringliteral">&quot;Psi3&quot;</span>, <span class="stringliteral">&quot;Psi4&quot;</span>]</div>
<div class="line">mode_set = [[2, 2], [3, 3]]</div>
<div class="line">filename = <span class="stringliteral">&quot;CharacteristicExtractReductionData.h5&quot;</span></div>
<div class="line">output_plot_filename = <span class="stringliteral">&quot;CCE_plot.pdf&quot;</span></div>
<div class="line"> </div>
<div class="line">legend = []</div>
<div class="line"><span class="keywordflow">for</span> (mode_l, mode_m) <span class="keywordflow">in</span> mode_set:</div>
<div class="line">    legend = np.append(legend, [</div>
<div class="line">        <span class="stringliteral">r&quot;Re $Y_{&quot;</span> + str(mode_l) + <span class="stringliteral">r&quot;\,&quot;</span> + str(mode_m) + <span class="stringliteral">r&quot;}$&quot;</span>,</div>
<div class="line">        <span class="stringliteral">r&quot;Im $Y_{&quot;</span> + str(mode_l) + <span class="stringliteral">r&quot;\,&quot;</span> + str(mode_m) + <span class="stringliteral">r&quot;}$&quot;</span></div>
<div class="line">    ])</div>
<div class="line"> </div>
<div class="line">plt.figure(figsize=(8, 1.9 * len(plot_quantities)))</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(plot_quantities)):</div>
<div class="line">    ax = plt.subplot(len(plot_quantities), 1, i + 1)</div>
<div class="line">    timeseries = np.transpose(</div>
<div class="line">        get_modes_from_block_output(filename, plot_quantities[i], mode_set))</div>
<div class="line">    <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(mode_set)):</div>
<div class="line">        plt.plot(timeseries[0], timeseries[j + 1], linestyle=<span class="stringliteral">&#39;--&#39;</span>, marker=<span class="stringliteral">&#39;&#39;</span>)</div>
<div class="line">    ax.set_xlabel(<span class="stringliteral">&quot;Simulation time (M)&quot;</span>)</div>
<div class="line">    ax.set_ylabel(<span class="stringliteral">&quot;Mode coefficient&quot;</span>)</div>
<div class="line">    ax.set_title(plot_quantities[i])</div>
<div class="line">plt.tight_layout()</div>
<div class="line">plt.savefig(output_plot_filename, dpi=400)</div>
<div class="line">plt.clf()</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md43"></a>
Input data formats</h2>
<p >The worldtube data must be constructed as spheres of constant coordinate radius, and (for the time being) written to a filename of the format <code>...CceRXXXX.h5</code>, where the <code>XXXX</code> is to be replaced by the integer for which the extraction radius is equal to <code>XXXX</code>M. For instance, a 100M extraction should have filename <code>...CceR0100.h5</code>. This scheme of labeling files with the extraction radius is constructed for compatibility with SpEC worldtube data.</p>
<p >There are two possible formats of the input data, one based on the Cauchy metric at finite radius, and one based on Bondi data. The metric data format must be provided as spherical harmonic modes with the following datasets:</p><ul>
<li><code>gxx.dat</code>, <code>gxy.dat</code>, <code>gxz.dat</code>, <code>gyy.dat</code>, <code>gyz.dat</code>, <code>gzz.dat</code></li>
<li><code>Drgxx.dat</code>, <code>Drgxy.dat</code>, <code>Drgxz.dat</code>, <code>Drgyy.dat</code>, <code>Drgyz.dat</code>, <code>Drgzz.dat</code></li>
<li><code>Dtgxx.dat</code>, <code>Dtgxy.dat</code>, <code>Dtgxz.dat</code>, <code>Dtgyy.dat</code>, <code>Dtgyz.dat</code>, <code>Dtgzz.dat</code></li>
<li><code>Shiftx.dat</code>, <code>Shifty.dat</code>, <code>Shiftz.dat</code></li>
<li><code>DrShiftx.dat</code>, <code>DrShifty.dat</code>, <code>DrShiftz.dat</code></li>
<li><code>DtShiftx.dat</code>, <code>DtShifty.dat</code>, <code>DtShiftz.dat</code></li>
<li><code>Lapse.dat</code></li>
<li><code>DrLapse.dat</code></li>
<li><code>DtLapse.dat</code></li>
</ul>
<p >In this format, each row must start with the time stamp, and the remaining values are the complex modes in m-varies-fastest format.</p>
<p >The second format is Bondi-Sachs metric component data. This format is far more space-efficient (by around a factor of 4), and SpECTRE provides a separate executable for converting to the Bondi-Sachs worldtube format, <code>ReduceCceWorldtube</code>. The <code>ReduceCceWorldtube</code> executable should be run on a Cauchy metric worldtube file, and will produce a corresponding 'reduced' Bondi-Sachs worldtube file. The basic command-line arguments for the executable are: </p><div class="fragment"><div class="line">ReduceCceWorldtube --input-file CceR0050.h5 --output-file BondiCceR0050.h5\</div>
<div class="line"> --lmax_factor 3</div>
</div><!-- fragment --><p> The argument <code>--lmax_factor</code> determines the factor by which the resolution at which the boundary computation that is run will exceed the resolution of the input and output files. Empirically, we have found that <code>lmax_factor</code> of 3 is sufficient to achieve roundoff precision in all boundary data we have attempted, and an <code>lmax_factor</code> of 2 is usually sufficient to vastly exceed the precision of the simulation that provided the boundary dataset.</p>
<p >The format is similar to the metric components, except in spin-weighted spherical harmonic modes, and the real (spin-weight-0) quantities omit the redundant negative-m modes and imaginary parts of m=0 modes. The quantities that must be provided by the Bondi-Sachs metric data format are:</p><ul>
<li><code>Beta.dat</code></li>
<li><code>DrJ.dat</code></li>
<li><code>DuR.dat</code></li>
<li><code>H.dat</code></li>
<li><code>J.dat</code></li>
<li><code>Q.dat</code></li>
<li><code>R.dat</code></li>
<li><code>U.dat</code></li>
<li><code>W.dat</code></li>
</ul>
<p >The Bondi-Sachs data may also be used directly for CCE input data. To specify that the input type is in 'reduced' Bondi-Sachs form, use: </p><div class="fragment"><div class="line">...</div>
<div class="line">Cce:</div>
<div class="line">  H5IsBondiData: True</div>
<div class="line">...</div>
</div><!-- fragment --><p> Otherwise, for the Cauchy metric data format, use: </p><div class="fragment"><div class="line">...</div>
<div class="line">Cce:</div>
<div class="line">  H5IsBondiData: False</div>
<div class="line">...</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">User Tutorials</a></li>
    <li class="footer">
    &copy; Copyright 2017 - 2023
    <a href="https://black-holes.org">SXS Collaboration</a>,
    <a href="LICENSE.txt" target="_blank">
    <span class="hidden-xs">Distributed under the</span>
    MIT License</a>
  </ul>
</div>
</body>
</html>
