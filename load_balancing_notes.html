<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="author" content="SXS Collaboration">
    <meta name="generator" content="Doxygen 1.9.3"/>
  <title>SpECTRE: Notes on SpECTRE load-balancing using Charm++&#39;s built-in load balancers</title>
  <link href="tabs.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="./MathJax.js"></script>
  <link href="octicons.css" rel="stylesheet">
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script type="text/javascript" src="spectre.js"></script>
  <script type="text/javascript" src="doxygen-navtree-hacks.js"></script>
  <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeParagraphLink.init()
  </script>
  </head>
  <body>
  <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
  <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
      <tbody>
        <tr style="height: 56px;">
          <td id="projectalign" style="padding-left: 0.5em;">
            <div id="projectname">
              <a href="index.html">SpECTRE</a>
              &#160;<span id="projectnumber">v2023.06.19</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('load_balancing_notes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Notes on SpECTRE load-balancing using Charm++'s built-in load balancers </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md110">Overview of how LBs work with SpECTRE</a></li>
<li class="level2"><a href="#autotoc_md111">Contaminated LB measurements on first invocation</a></li>
<li class="level2"><a href="#autotoc_md112">Scotch load balancer</a></li>
<li class="level2"><a href="#autotoc_md113">General recommendations</a><ul><li class="level3"><a href="#autotoc_md114">Homogeneous loads</a></li>
<li class="level3"><a href="#autotoc_md115">Inhomogeneous loads</a></li>
</ul>
</li>
</ul>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_DevGuide_LoadBalancingNotes"></a></p>
<p >The goal of load-balancing (LB) is to ensure that HPC resources are well-used while performing large inhomogeneous simulations. In 2020-2021, Jordan Moxon and Francois Hebert performed a number of tests using Charm++'s built-in load balancers with SpECTRE.</p>
<p >These notes highlight the key points and give (at the bottom) some general recommendations.</p>
<h2><a class="anchor" id="autotoc_md110"></a>
Overview of how LBs work with SpECTRE</h2>
<p >In late 2020 FH tested Charm's LBs on simple, homogeneous, SpECTRE test cases. These tests reveal the following broad behavior patterns:</p><ul>
<li>Without using any LBs (no LB command-line args, or <code>+balancer NullLB</code>), SpECTRE's performance depends sensitively on how the DG elements are distributed over the HPC system. This indicates that communication costs are very important in SpECTRE runs. This statement remains true for more expensive evolution systems like Generalized Harmonic.</li>
<li>Charm's LBs that are not communications aware (e.g., <code>GreedyLB</code>, <code>RefineLB</code>, ...) all result in low parallel efficiency (20-30%). This is consistent with the understanding that communication costs are large. A good initial distribution of elements over processors will be degraded by these LBs, leading to more complicated communication graph and loss of performance.</li>
<li>Some of Charm's communication-aware LBs perform well: they approach the efficiency of a "manually tuned" initial distribution of elements onto processors. This suggests these LBs do a good job of partitioning the communications graph. In FH's simple tests, the best results were from <code>RecBipartLB</code>, which came within 10-20% of a manual initial distribution. However, it is a slow algorithm and is best used infrequently or only a few times near the start of the simulation.</li>
</ul>
<p >Note that at the 2020 Charm++ Workshop, the Charm team recommended that we use <code>MetisLB</code>, or that we combined <code>MetisLB</code> with <code>RefineLB</code> (syntax: <code>+balancer MetisLB +balancer RefineLB</code>, which applies the first balancer on the first invocation and the second balancer on all subsequent invocations, to 'polish' the results of the first LB). In practice, this failed for two reasons:</p><ul>
<li><code>MetisLB</code> tends to error with FPEs</li>
<li>When falling back to the pairing of <code>RecBipartLB</code> followed by <code>RefineLB</code>, the run starts with good performance. However, within a few applications of <code>RefineLB</code>, the performance is heavily degraded (down to 20-30% efficiency). It appears that we should stick to the comm-aware LB strategies.</li>
</ul>
<h2><a class="anchor" id="autotoc_md111"></a>
Contaminated LB measurements on first invocation</h2>
<p >There is reason to suspect that the Charm load balancing may incorrectly balance the load when applied near the start of some simulations. This is because the 'one-time' setup of the system may involve nontrivial computation, and (e.g. for numeric initial data) communication patterns between components that differ significantly from the patterns during evolution. Then, the first balancer invocation, based partially on the measurements taken during the non-generalizable initialization phase, can give rise to a poorly-chosen balance and injure performance. This is the suspected cause of poor performance that has been noticed in cases of homogeneous load and numeric initial data in Generalized Harmonic tests performed by Geoffrey Lovelace. JM confirmed the problem. It appears that the balance is not similarly degraded when using cases that do not involve numeric initial data &ndash; some basic 2-node re-tests with Generalized Harmonic by JM seem to produce useful balance (improved performance) when not using numeric initial data.</p>
<p >This issue has not been investigated to a completely satisfactory conclusion, though the above explanation seems most plausible.</p>
<p >In cases for which it appears that the LB data is problematically impacted by the set up of the evolution system, we can try two main strategies to mitigate the problem:</p><ul>
<li>Apply the load balancer at least two times near the start of the simulation, with sufficient gaps to collect useful balancing information. The LB database in Charm is cleared every time a balance is applied, so the later balances during the evolution should be uncontaminated. This strategy has not yet been carefully tested. To do this, use an input file similar to <div class="fragment"><div class="line">PhaseChangeAndTriggers:</div>
<div class="line">  - Trigger:</div>
<div class="line">      Slabs:</div>
<div class="line">        Specified:</div>
<div class="line">          Values: [5, 10, 15]</div>
<div class="line">    PhaseChanges:</div>
<div class="line">      - VisitAndReturn(LoadBalancing)</div>
</div><!-- fragment --></li>
<li>Use <code>LBTurnInstrumentOff</code> and <code>LBTurnInstrumentOn</code> to specifically exclude setup procedures from the LB instrumentation. First attempts indicate that this process might be challenging to accomplish correctly, and may require correspondence with the Charm developers to clarify at what points in the code execution those commands may be used, and precisely how they affect the load-balancing database. A first attempt by JM was to turn instrumentation off during array element construction, then turn instrumentation on for each element during the start of the <code>Evolve</code> phase, but that attempt led to a hang of the system, so the utility must have more constraints than were initially apparent.</li>
</ul>
<h2><a class="anchor" id="autotoc_md112"></a>
Scotch load balancer</h2>
<p >JM tested <code>ScotchLB</code>, and found better performance than with <code>RecBipartLB</code>. The margin varied a great deal among the number of nodes used, but at multiple points tested, the runtime was less than 65% of the <code>RecBipartLB</code> runtime. The tests were performed with homogeneous load, but starting from the round-robin element distribution. The indication is therefore that <code>ScotchLB</code> is very effective at minimizing communication costs.</p>
<p >However, in practical applications, JM found that the <code>ScotchLB</code> often generates FPEs during the graph partition step and causes the simulation to crash. The issue <a href="https://github.com/UIUC-PPL/charm/issues/3401">charm++ issue #3401</a> tracks the progress to determine the cause of the problem and fix it in Charm. The source of the problem has largely been identified, but the fix is still pending.</p>
<p ><code>ScotchLB</code> will likely replace <code>RecBipartLB</code> as the most-frequently recommended centralized communication based balancer for SpECTRE once the FPE bugs have been fixed.</p>
<h2><a class="anchor" id="autotoc_md113"></a>
General recommendations</h2>
<h3><a class="anchor" id="autotoc_md114"></a>
Homogeneous loads</h3>
<p >For homogeneous loads, it is likely best to omit load-balancing and just use the z-curve distribution (default) to give a good initial distribution and use that for the entire evolution. This means calling the SpECTRE executable with no LB-related command-line args, or with <code>+balancer NullLB</code>.</p>
<p >You may find modest gains from using a communication-based load balancer, but likely only from the 'extra' parallel components of the system that cause the load to be not completely homogeneous (e.g., components like the interpolator or horizon finder). If you need a very long evolution or intend to submit a large number of evolutions, it may be worth experimenting to see whether 1-3 applications of <code>RecBipartLB</code> (or <code>ScotchLB</code> once its bugs are fixed, see above) improve performance for the system, for instance by using the input file: </p><div class="fragment"><div class="line">PhaseChangeAndTriggers:</div>
<div class="line">  - Trigger:</div>
<div class="line">      Slabs:</div>
<div class="line">        Specified:</div>
<div class="line">          Values: [5, 10, 15]</div>
<div class="line">    PhaseChanges:</div>
<div class="line">      - VisitAndReturn(LoadBalancing)</div>
</div><!-- fragment --><p> and command-line args <code>+balancer RecBipartLB</code> (or <code>ScotchLB</code> when its bugs are fixed). This may be particularly relevant for cases with numeric initial data or other complicated set-up procedures.</p>
<h3><a class="anchor" id="autotoc_md115"></a>
Inhomogeneous loads</h3>
<p >Based on our experiments, we anticipate that using a load-balancer may significantly improve runtimes with inhomogeneous loads. Our testing on this case is far more sparse, but for SpECTRE executables, it is probably remains true that managing communication costs will be an important goal for the balancer. It is likely worth attempting the evolution with a periodically-applied centralized communication-aware balancer, e.g.: </p><div class="fragment"><div class="line">PhaseChangeAndTriggers:</div>
<div class="line">  - Trigger:</div>
<div class="line">      Slabs:</div>
<div class="line">        EvenlySpaced:</div>
<div class="line">          Interval: 1000</div>
<div class="line">          Offset: 5</div>
<div class="line">    PhaseChanges:</div>
<div class="line">      - VisitAndReturn(LoadBalancing)</div>
</div><!-- fragment --><p> paired with command-line args <code>+balancer RecBipartLB</code> (or <code>ScotchLB</code> when its bugs are fixed).</p>
<p >Important considerations when choosing the interval with which to balance are:</p><ul>
<li>you will want to ensure that the balancer is applied frequently enough to prioritize expensive parts of the simulation before any relevent features 'move' to other elements. For example, if a shock is moving across the simulation domain causing certain elements to be more expensive to compute, you want to balance often enough that the LB 'keeps up' with the movement of the shock.</li>
<li>you will want to avoid balancing so frequently that the synchronization and balancer calculation itself becomes a significant portion of runtime.</li>
</ul>
<p >We have not yet taken much detailed data on using the load-balancers for inhomogeneous loads, so more detailed tests determining their efficacy would be valuable. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dev_guide.html">Developer Guides</a></li>
    <li class="footer">
    &copy; Copyright 2017 - 2023
    <a href="https://black-holes.org">SXS Collaboration</a>,
    <a href="LICENSE.txt" target="_blank">
    <span class="hidden-xs">Distributed under the</span>
    MIT License</a>
  </ul>
</div>
</body>
</html>
